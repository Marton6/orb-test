description: >
  Run a program with SecretHub and pass secret environment variables to it.
parameters:
  command:
    type: string
    default: "help"
    description: "Command to run with SecretHub"
  env-file:
    type: string
    default: "secrethub.env"
    description: "The path to the Environment File with environment variable mappings."
  template-version:
    type: string
    default: "auto"
    description: "The template syntax version to be used. (v1, v2, latest or auto)"
  masking-timeout:
    type: string
    default: 1s
    description: "The time to wait for the write of a secret that is partially written to stdout or stderr to be completed."
  version:
    type: string
    default: "latest"
    description: "Version of the SecretHub CLI"

steps:
  - run:
      name: "Install SecretHub CLI"
      command: |

        if [[ $EUID == 0 ]]; then export SUDO=""; else export SUDO="sudo"; fi

        # If the version is not explicitly specified then use the existing one if possible.
        if [[ <<parameters.version>> == "latest" ]]  && command -v secrethub >/dev/null 2>&1; then
            exit 0
        fi

        # Get the latest version.
        VERSION=<<parameters.version>>
        if [[ $VERSION == "latest" ]]; then
            VERSION=$(curl --silent --show-error --location --fail --retry 3 \
            https://api.github.com/repos/secrethub/secrethub-cli/releases/latest | grep tag_name | sed -r 's/"tag_name": "([^ ]+)".*/\1/')
        fi
        VERSION=$(echo $VERSION | tr -d " ")

        # Get the current platform.
        if uname -a | grep Darwin > /dev/null 2>&1; then
            PLATFORM=darwin
        else
            PLATFORM=linux
        fi

        # If the CLI is not installed or the current version of the CLI does not match the specified one, download the provided version.
        if ! command -v secrethub >/dev/null 2>&1 || [[ $(secrethub --version 2>&1 | sed -r 's/secrethub version ([^,]*).*/\1/') == $VERSION ]]; then
            curl -sSfL https://github.com/secrethub/secrethub-cli/releases/download/$VERSION/secrethub-$VERSION-$PLATFORM-amd64.tar.gz | $SUDO tar zxf - -C ./ && $SUDO mv ./bin/* /usr/bin/ && $SUDO rm -rf ./bin
        fi
  - run: secrethub run
          --env-file << parameters.env-file >>
          --template-version << parameters.template-version >>
          --no-masking << parameters.no-masking >>
          -- << parameters.command >>
